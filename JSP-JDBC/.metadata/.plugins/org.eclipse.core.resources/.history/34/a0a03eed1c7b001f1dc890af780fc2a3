package servlets;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.HashMap;

/**
 * Servlet implementation class Controller
 */
public class Controller extends HttpServlet {
	private static final long serialVersionUID = 1L;
       
    /**
     * @see HttpServlet#HttpServlet()
     */
    public Controller() {
        super();
        // TODO Auto-generated constructor stub
    }

    /**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		
		String operacion=request.getParameter("operacion");// ¿Que se te ofrece?
		
		
		HashMap<String, String> diasSemana = new HashMap<String, String>();
		diasSemana.put("MONDAY", "LUNES");
		diasSemana.put("TUESDAY", "MARTES");
		diasSemana.put("WEDNESDAY", "MIÉRCOLES");
		diasSemana.put("THURSDAY", "JUEVES");
		diasSemana.put("FRIDAY", "VIERNES");
		diasSemana.put("SATURDAY", "SÁBADO");
		diasSemana.put("SUNDAY", "DOMINGO");		
		switch (operacion) {
		case "matricular":
			
			String nombre=request.getParameter("nombre");
			System.out.println("Nombre antes de transformar  con getBytes: "+nombre);
			String nombreTransformado=new String(nombre.getBytes("UTF-8"));
			System.out.println("Nombre transformado con getBytes: "+nombreTransformado);
			String apellido1=request.getParameter("apellido1");
			String apellido2=request.getParameter("apellido2");
			String email=request.getParameter("email");
			/**
			 *  La fecha se lee como una cadena de caracteres
			 *  Como hemos usado el control de fecha HTML5, la fecha se devuelve
			 *  segun ISO 8601. Es decir, año-mes-dia
			 */
			String strfechanacimiento=request.getParameter("fechanacimiento");
			/**
			 *  Establecemos el formato de fecha al patrón que sabemos que nos devuelve
			 *  el control input type="date"
			 */
			DateTimeFormatter formatoDeFecha=DateTimeFormatter.ofPattern("yyyy-MM-dd");
			/**
			 *  Creamos un objeto LocalDate a partir de la fecha obtenida en forma de cadena
			 *  usando el método parse.
			 */
			LocalDate fechanacimiento=LocalDate.parse(strfechanacimiento,formatoDeFecha);
			/**
			 *   Obtenemos el día de la semana  ( en inglés). Usaremos un hashmap para 
			 *   traducirlo al español.
			 */
			String diasemanaingles=fechanacimiento.getDayOfWeek().name();
			String diasemana=diasSemana.get(diasemanaingles);
			
			/**
			 *  En la capa de presentación voy a usar la etiqueta JSTL fmt:formatDate
			 *  para mostrar la fecha que hemos guardado en el objeto LocalDate en
			 *  formato dd-MM-yyyy.
			 *  El uso de esa etiqueta exige un objeto de tipo java.util.Date o su clase
			 *  heredada java.sql.Date. Por lo que creamos un objeto java.sql.Date para 
			 *  guardarlo como atributo para que la capa de presentación lo muestre
			 *  con el formato que hemos elegido.
			 *  
			 *  <fmt:formatDate pattern="dd-MM-yyyy" value="${fechanacimiento}"/>
			 */
			
			java.sql.Date sqlDatefechanacimiento=java.sql.Date.valueOf(fechanacimiento);
			request.setAttribute("fechanacimiento", sqlDatefechanacimiento);
			
			String provincianacimiento=request.getParameter("provincianacimiento");
			
			String emancipado=request.getParameter("emancipado");
			
			String[]modulosmatriculados=request.getParameterValues("modulos");
			
			// Establecer los atributos a mostrar en la capa de presentacion

			request.setAttribute("nombre", nombre);
			request.setAttribute("apellido1", apellido1);
			request.setAttribute("apellido2", apellido2);
			
			String alumno=apellido1+((apellido2.equals(""))?","+" "+nombre:" "+apellido2+", "+nombre);
			
			request.setAttribute("alumno", alumno);
			
			
			request.setAttribute("email", email);
			request.setAttribute("provincianacimiento", provincianacimiento);

			request.setAttribute("fechanacimiento", sqlDatefechanacimiento);
			request.setAttribute("diasemananacimiento",diasemana);
			request.setAttribute("emancipado", emancipado);
			request.setAttribute("modulosmatriculados", modulosmatriculados);
			//response.sendRedirect("confirmacionmatricula.jsp?nombre="+nombre);
			request.getRequestDispatcher("confirmacionmatricula.jsp").forward(request, response);

			break;

		default:
			break;
		}
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		System.out.println("He sido llamado...");
		doGet(request, response);
	}



}
